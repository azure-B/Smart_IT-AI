version: '3.8'

services:
  # =========================================
  # 1번 모드: 혼자 테스트하기 (main.py)
  # =========================================
  ai-test:
    build: ./smart_IT-AI
    container_name: dog-test
    command: python main.py     # main.py 실행 강제 지정
    stdin_open: true            # 입력(input) 가능하게 설정
    tty: true                   # 터미널 화면 연결
    volumes:
      - ./smart_IT-AI:/app
    deploy:                     # GPU 설정 (RTX 5060)
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

  # =========================================
  # 2번 모드: Node.js와 연동하기 (server.py)
  # =========================================
  ai-server:
    build: ./smart_IT-AI
    container_name: dog-server
    command: uvicorn server:app --host 0.0.0.0 --port 8000 # 서버 모드로 실행
    ports:
      - "8000:8000"
    volumes:
      - ./smart_IT-AI:/app
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

  # Node.js 서버 (AI 서버가 켜져야만 실행됨)
  node-app:
    build: ./smart_IT-Node
    container_name: dog-node
    ports:
      - "3000:3000"
    depends_on:
      - ai-server
    environment:
      - AI_API_URL=http://ai-server:8000